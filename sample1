using System;
using Excel = Microsoft.Office.Interop.Excel;

class ExcelInteropExample
{
    public void RefreshPivotAndSort(string filePath, string pivotSheetName, string dataSheetName, string sortColumn)
    {
        Excel.Application excelApp = new Excel.Application();
        Excel.Workbook workbook = excelApp.Workbooks.Open(filePath);
        Excel.Worksheet pivotSheet = workbook.Sheets[pivotSheetName];
        Excel.Worksheet dataSheet = workbook.Sheets[dataSheetName];

        try
        {
            // Refresh the pivot table
            RefreshPivotTable(pivotSheet);

            // Activate the data sheet
            dataSheet.Activate();

            // Identify the range to sort (assuming header is in the first row and data starts from A1)
            Excel.Range dataRange = dataSheet.UsedRange;
            Excel.Range sortRange = dataSheet.Range["A1", dataRange.SpecialCells(Excel.XlCellType.xlCellTypeLastCell)];

            // Apply sorting
            SortRange(dataSheet, sortRange, sortColumn);

            // Save and close workbook
            workbook.Save();
            workbook.Close();
        }
        finally
        {
            // Clean up Excel objects
            ReleaseObject(pivotSheet);
            ReleaseObject(dataSheet);
            ReleaseObject(workbook);
            ReleaseObject(excelApp);
        }
    }

    private void RefreshPivotTable(Excel.Worksheet sheet)
    {
        foreach (Excel.PivotTable pivotTable in sheet.PivotTables())
        {
            pivotTable.RefreshTable();
        }
    }

    private void SortRange(Excel.Worksheet sheet, Excel.Range range, string sortColumn)
    {
        int columnNumber = GetColumnNumber(sheet, sortColumn);

        Excel.Range sortRange = range.Columns[columnNumber];
        Excel.Sort sort = sheet.Sort;
        sort.SortFields.Clear();
        sort.SortFields.Add(
            sortRange,
            Excel.XlSortOn.xlSortOnValues,
            Excel.XlSortOrder.xlAscending
        );
        sort.SetRange(range);
        sort.Header = Excel.XlYesNoGuess.xlYes;
        sort.MatchCase = false;
        sort.Orientation = Excel.XlSortOrientation.xlSortRows;
        sort.SortMethod = Excel.XlSortMethod.xlPinYin;
        sort.Apply();
    }

    private int GetColumnNumber(Excel.Worksheet sheet, string columnLetter)
    {
        Excel.Range cell = sheet.Cells[1, columnLetter];
        return cell.Column;
    }

    private void ReleaseObject(object obj)
    {
        try
        {
            System.Runtime.InteropServices.Marshal.ReleaseComObject(obj);
            obj = null;
        }
        catch (Exception ex)
        {
            obj = null;
            Console.WriteLine("Exception occurred while releasing object: " + ex.ToString());
        }
        finally
        {
            GC.Collect();
        }
    }
}
