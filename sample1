using System;
using System.Runtime.InteropServices;
using Excel = Microsoft.Office.Interop.Excel;

class Program
{
    static void Main(string[] args)
    {
        string filePath = @"C:\path\to\your\file.xlsx";
        string sheetName = "Sheet1"; // The sheet where the PivotTable is located
        string pivotTableName = "PivotTable1"; // The name of the PivotTable to update
        string newDataSourceRange = "Sheet1!A1:D100"; // New data source range, adjust as necessary

        Excel.Application excelApp = new Excel.Application();
        Excel.Workbook workbook = null;
        Excel.Worksheet worksheet = null;

        try
        {
            // Open the workbook
            workbook = excelApp.Workbooks.Open(filePath);
            worksheet = workbook.Sheets[sheetName] as Excel.Worksheet;

            if (worksheet != null)
            {
                // Access the PivotTable
                Excel.PivotTable pivotTable = worksheet.PivotTables(pivotTableName) as Excel.PivotTable;

                if (pivotTable != null)
                {
                    // Create a new PivotCache
                    Excel.PivotCache newPivotCache = workbook.PivotCaches().Create(
                        SourceType: Excel.XlPivotTableSourceType.xlDatabase,
                        SourceData: newDataSourceRange
                    );

                    // Change the PivotCache of the PivotTable
                    pivotTable.ChangePivotCache(newPivotCache);

                    // Refresh the PivotTable
                    pivotTable.RefreshTable();

                    // Save the workbook
                    workbook.Save();
                    Console.WriteLine("PivotTable data source updated successfully.");
                }
                else
                {
                    Console.WriteLine($"PivotTable '{pivotTableName}' not found.");
                }
            }
            else
            {
                Console.WriteLine($"Sheet '{sheetName}' not found.");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"An error occurred: {ex.Message}");
        }
        finally
        {
            // Clean up
            if (workbook != null)
            {
                workbook.Close(false);
                Marshal.ReleaseComObject(workbook);
            }
            excelApp.Quit();
            Marshal.ReleaseComObject(excelApp);
        }
    }
}
