using Excel = Microsoft.Office.Interop.Excel;

class ExcelInteropExample
{
    public void CopyDataExcludingPivotTables(string sourceFilePath, string sourceSheetName, string targetSheetName)
    {
        Excel.Application excelApp = new Excel.Application();
        Excel.Workbook workbook = excelApp.Workbooks.Open(sourceFilePath);
        Excel.Worksheet sourceSheet = workbook.Sheets[sourceSheetName];
        Excel.Worksheet targetSheet = workbook.Sheets[targetSheetName];

        try
        {
            // Activate the target worksheet
            targetSheet.Activate();

            // Find the used range excluding pivot tables and only visible cells in the source sheet
            Excel.Range usedRange = GetVisibleUsedRange(sourceSheet);

            // Clear existing data in destination range A1:Gx (where x is the last row in used range)
            Excel.Range targetRange = targetSheet.Range["A1:G" + usedRange.Rows.Count];
            targetRange.ClearContents();

            // Copy values excluding pivot tables
            if (usedRange != null)
            {
                targetRange.Value = usedRange.Value;
            }

            // Optionally, if you need to delete specific rows, here is how you could do it:
            // Example: Deleting row 1 to lastRow
            for (int row = usedRange.Rows.Count; row >= 1; row--)
            {
                Excel.Range currentRow = targetSheet.Rows[row];
                currentRow.Delete();
            }

            // Save and close workbook
            workbook.Save();
            workbook.Close();
        }
        finally
        {
            // Clean up Excel objects
            ReleaseObject(sourceSheet);
            ReleaseObject(targetSheet);
            ReleaseObject(workbook);
            ReleaseObject(excelApp);
        }
    }

    private Excel.Range GetVisibleUsedRange(Excel.Worksheet sheet)
    {
        Excel.Range lastCell = sheet.Cells.SpecialCells(Excel.XlCellType.xlCellTypeLastCell);
        Excel.Range usedRange = sheet.Range["A1", lastCell];

        // Find the last row in the used range that is visible
        int lastRow = 0;
        foreach (Excel.Range row in usedRange.Rows)
        {
            if (row.Hidden == false && row.EntireRow.Hidden == false)
            {
                lastRow = row.Row;
            }
        }

        // Return range from A1 to lastRow and column G
        return sheet.Range["A1:G" + lastRow];
    }

    private void ReleaseObject(object obj)
    {
        try
        {
            System.Runtime.InteropServices.Marshal.ReleaseComObject(obj);
            obj = null;
        }
        catch (System.Exception ex)
        {
            obj = null;
            Console.WriteLine("Exception occurred while releasing object " + ex.ToString());
        }
        finally
        {
            GC.Collect();
        }
    }
}
