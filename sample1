using System;
using System.Collections.Generic;
using System.IO;
using System.Text.RegularExpressions;
using Excel = Microsoft.Office.Interop.Excel;

class Program
{
    static void Main()
    {
        // Path to the notepad file
        string notepadFilePath = "path/to/notepad.txt";

        // Path to the existing Excel file
        string excelFilePath = "path/to/excel.xlsx";

        // Read line numbers from the notepad file
        Dictionary<int, string> lineNumbers = ReadLineNumbersFromNotepad(notepadFilePath);

        // Initialize Excel application
        Excel.Application excelApp = new Excel.Application();
        excelApp.Visible = true;

        // Open existing Excel file
        Excel.Workbook workbook = excelApp.Workbooks.Open(excelFilePath);
        Excel.Worksheet worksheet = workbook.ActiveSheet;

        // Find the column index of "SlNo"
        int slNoColumnIndex = FindColumnIndex(worksheet, "SlNo");

        if (slNoColumnIndex == -1)
        {
            Console.WriteLine("Column 'SlNo' not found in the Excel sheet.");
            return;
        }

        // Delete rows that do not match the lineNumbers
        DeleteRowsNotInLineNumbers(worksheet, slNoColumnIndex, lineNumbers);

        // Save changes and close Excel
        workbook.Save();
        workbook.Close();
        excelApp.Quit();

        // Release Excel objects from memory
        System.Runtime.InteropServices.Marshal.ReleaseComObject(worksheet);
        System.Runtime.InteropServices.Marshal.ReleaseComObject(workbook);
        System.Runtime.InteropServices.Marshal.ReleaseComObject(excelApp);
    }

    static Dictionary<int, string> ReadLineNumbersFromNotepad(string filePath)
    {
        Dictionary<int, string> lineNumbers = new Dictionary<int, string>();
        try
        {
            using (StreamReader sr = new StreamReader(filePath))
            {
                string line;
                while ((line = sr.ReadLine()) != null)
                {
                    // Extract the line number using regular expression
                    Match match = Regex.Match(line, @"line no (\d+)", RegexOptions.IgnoreCase);
                    if (match.Success)
                    {
                        int lineNumber = int.Parse(match.Groups[1].Value);
                        if (lineNumbers.ContainsKey(lineNumber))
                        {
                            // Append to existing line number with comma separator
                            lineNumbers[lineNumber] += ", " + lineNumber;
                        }
                        else
                        {
                            lineNumbers[lineNumber] = lineNumber.ToString();
                        }
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine("Error reading line numbers from notepad file: " + ex.Message);
        }
        return lineNumbers;
    }

    static int FindColumnIndex(Excel.Worksheet worksheet, string columnName)
    {
        Excel.Range headerRow = worksheet.Rows[1];
        foreach (Excel.Range cell in headerRow.Cells)
        {
            if (cell.Value != null && cell.Value.ToString().Equals(columnName, StringComparison.OrdinalIgnoreCase))
            {
                return cell.Column;
            }
        }
        return -1; // Column not found
    }

    static void DeleteRowsNotInLineNumbers(Excel.Worksheet worksheet, int columnIndex, Dictionary<int, string> lineNumbers)
    {
        Excel.Range usedRange = worksheet.UsedRange;
        int rowCount = usedRange.Rows.Count;

        for (int i = rowCount; i >= 2; i--) // Start from row 2 (excluding header row)
        {
            Excel.Range cell = (Excel.Range)worksheet.Cells[i, columnIndex];
            if (cell.Value != null && int.TryParse(cell.Value.ToString(), out int slNo))
            {
                if (!lineNumbers.ContainsKey(slNo))
                {
                    // Delete the entire row if SlNo is not in lineNumbers
                    Excel.Range rowToDelete = (Excel.Range)worksheet.Rows[i];
                    rowToDelete.Delete();
                }
            }
        }
    }
}
