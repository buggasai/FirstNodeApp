using System;
using System.Runtime.InteropServices;
using Excel = Microsoft.Office.Interop.Excel;

class Program
{
    static void Main()
    {
        // Create a new Excel application
        Excel.Application excelApp = new Excel.Application();
        
        // Make the application visible (optional)
        excelApp.Visible = true;

        // Add a new workbook
        Excel.Workbook workbook = excelApp.Workbooks.Add();
        
        // Get the active sheet
        Excel.Worksheet worksheet = (Excel.Worksheet)workbook.ActiveSheet;

        // Define the formula for column G
        string formulaG = @"=IFNA(VLOOKUP(A4,'edlohn kunden'!A:L,7,0),""0"")";

        // Specify the range where you want to insert the formula in column G
        Excel.Range startCellG = worksheet.Cells[4, 7]; // Cell G4
        Excel.Range endCellG = worksheet.Cells[1000, 7]; // Adjust to a reasonable number of rows
        Excel.Range fillRangeG = worksheet.Range[startCellG, endCellG];

        // Fill the range with the formula
        fillRangeG.Formula = formulaG;

        // Set the filter on column G for the value "BOB"
        Excel.Range filterRange = worksheet.Range["A3", "G1000"]; // Adjust to your data range
        filterRange.AutoFilter(7, "BOB", Excel.XlAutoFilterOperator.xlFilterValues);

        // Optional: AutoFit the columns
        worksheet.Columns["G"].AutoFit();

        // Clean up
        GC.Collect();
        GC.WaitForPendingFinalizers();
        Marshal.ReleaseComObject(fillRangeG);
        Marshal.ReleaseComObject(startCellG);
        Marshal.ReleaseComObject(endCellG);
        Marshal.ReleaseComObject(filterRange);
        Marshal.ReleaseComObject(worksheet);
        workbook.Close(false);
        Marshal.ReleaseComObject(workbook);
        excelApp.Quit();
        Marshal.ReleaseComObject(excelApp);
    }
}
