using Excel = Microsoft.Office.Interop.Excel;

class Program
{
    static void Main()
    {
        // Create a new instance of Excel application
        Excel.Application excelApp = new Excel.Application();

        // Open the workbook (replace with the path to your Excel file)
        Excel.Workbook workbook = excelApp.Workbooks.Open(@"C:\Path\To\Your\Workbook.xlsx");

        try
        {
            // Assuming your data starts from row 9 and columns I, J, K, L, M, N
            Excel.Worksheet worksheet = workbook.Worksheets["Sheet1"];

            // Loop through each row starting from row 9
            int rowCount = worksheet.Cells.SpecialCells(Excel.XlCellType.xlCellTypeLastCell).Row;
            for (int row = 9; row <= rowCount; row++)
            {
                // Get cell references
                Excel.Range cellI = worksheet.Cells[row, "I"];
                Excel.Range cellJ = worksheet.Cells[row, "J"];
                Excel.Range cellK = worksheet.Cells[row, "K"];
                Excel.Range cellL = worksheet.Cells[row, "L"];
                Excel.Range cellM = worksheet.Cells[row, "M"];
                Excel.Range cellN = worksheet.Cells[row, "N"];

                Excel.Range cellResult = worksheet.Cells[row, "O"]; // Assuming result goes into column O

                // Apply the formula programmatically
                string formula = $"=I{row}*$B$2+J{row}*$B$3+K{row}*$B$4+$B$5*L{row}+M{row}*$E$2+N{row}*$E$3";
                cellResult.Formula = formula;
            }

            // Save the workbook
            workbook.Save();

            Console.WriteLine("Formulas applied successfully.");
        }
        catch (Exception ex)
        {
            Console.WriteLine("Error applying formulas: " + ex.Message);
        }
        finally
        {
            // Close the workbook and Excel application
            workbook.Close();
            excelApp.Quit();

            // Release COM objects to avoid memory leaks
            ReleaseObject(worksheet);
            ReleaseObject(workbook);
            ReleaseObject(excelApp);
        }
    }

    // Helper method to release COM objects
    private static void ReleaseObject(object obj)
    {
        try
        {
            System.Runtime.InteropServices.Marshal.ReleaseComObject(obj);
            obj = null;
        }
        catch (System.Exception ex)
        {
            obj = null;
            Console.WriteLine("Exception Occured while releasing object " + ex.ToString());
        }
        finally
        {
            GC.Collect();
        }
    }
}
