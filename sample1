using System;
using System.Collections.Generic;
using System.IO;
using System.Text.RegularExpressions;
using System.Linq;
using Excel = Microsoft.Office.Interop.Excel;

class Program
{
    static void Main()
    {
        // Path to the notepad file
        string notepadFilePath = "path/to/notepad.txt";

        // Path to the existing Excel file
        string excelFilePath = "path/to/excel.xlsx";

        // Read line numbers from the notepad file
        Dictionary<int, string> lineNumbers = ReadLineNumbersFromNotepad(notepadFilePath);

        // Initialize Excel application
        Excel.Application excelApp = new Excel.Application();
        excelApp.Visible = true;

        // Open existing Excel file
        Excel.Workbook workbook = excelApp.Workbooks.Open(excelFilePath);
        Excel.Worksheet worksheet = workbook.ActiveSheet;

        // Find the last column in the worksheet
        int lastColumn = worksheet.Cells.SpecialCells(Excel.XlCellType.xlCellTypeLastCell).Column;

        // Insert new column at the last position
        Excel.Range range = (Excel.Range)worksheet.Cells[1, lastColumn + 1];
        range.EntireColumn.Insert(Excel.XlInsertShiftDirection.xlShiftToRight);

        // Add line numbers to the new column
        Excel.Range lineNumberRange = worksheet.Cells[1, lastColumn];
        foreach (var kvp in lineNumbers)
        {
            lineNumberRange.Value += kvp.Value + Environment.NewLine;

            // Move to the next row
            lineNumberRange = lineNumberRange.Offset[1, 0];
        }

        // Save changes and close Excel
        workbook.Save();
        workbook.Close();
        excelApp.Quit();

        // Release Excel objects from memory
        System.Runtime.InteropServices.Marshal.ReleaseComObject(worksheet);
        System.Runtime.InteropServices.Marshal.ReleaseComObject(workbook);
        System.Runtime.InteropServices.Marshal.ReleaseComObject(excelApp);
    }

    static Dictionary<int, string> ReadLineNumbersFromNotepad(string filePath)
    {
        Dictionary<int, string> lineNumbers = new Dictionary<int, string>();
        try
        {
            using (StreamReader sr = new StreamReader(filePath))
            {
                string line;
                while ((line = sr.ReadLine()) != null)
                {
                    // Extract the line number using regular expression
                    Match match = Regex.Match(line, @"line no (\d+)", RegexOptions.IgnoreCase);
                    if (match.Success)
                    {
                        int lineNumber = int.Parse(match.Groups[1].Value);
                        if (lineNumbers.ContainsKey(lineNumber))
                        {
                            // Append to existing line number with comma separator
                            lineNumbers[lineNumber] += ", " + lineNumber;
                        }
                        else
                        {
                            lineNumbers[lineNumber] = lineNumber.ToString();
                        }
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine("Error reading line numbers from notepad file: " + ex.Message);
        }
        return lineNumbers;
    }
}
