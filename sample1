using System;
using Excel = Microsoft.Office.Interop.Excel;

class ExcelInteropExample
{
    public void ClearFilters(string filePath, string sheetName)
    {
        Excel.Application excelApp = new Excel.Application();
        Excel.Workbook workbook = excelApp.Workbooks.Open(filePath);
        Excel.Worksheet sheet = workbook.Sheets[sheetName];

        try
        {
            // Activate the sheet
            sheet.Activate();

            // Clear filters in columns H and I
            ClearColumnFilter(sheet, "H");
            ClearColumnFilter(sheet, "I");

            // Save and close workbook
            workbook.Save();
            workbook.Close();
        }
        catch (Exception ex)
        {
            Console.WriteLine("Error: " + ex.Message);
        }
        finally
        {
            // Clean up Excel objects
            ReleaseObject(sheet);
            ReleaseObject(workbook);
            ReleaseObject(excelApp);
        }
    }

    private void ClearColumnFilter(Excel.Worksheet sheet, string columnName)
    {
        int columnIndex = GetColumnIndex(sheet, columnName);
        if (columnIndex > 0)
        {
            Excel.Range headerCell = sheet.Cells[3, columnIndex]; // Assuming filters start from row 3
            Excel.Range headerRow = sheet.Rows[3];
            
            // Check if there are any filters currently applied
            if (sheet.AutoFilter != null)
            {
                // Clear all existing filters
                sheet.AutoFilterMode = false;
            }

            // Apply the filter to the column if it doesn't intersect with a pivot table
            if (!IsPivotTableColumn(sheet, columnIndex))
            {
                headerRow.AutoFilter(columnIndex);
            }
            else
            {
                Console.WriteLine("Column " + columnName + " contains pivot table data. Skipping filter clear.");
            }
        }
    }

    private bool IsPivotTableColumn(Excel.Worksheet sheet, int columnIndex)
    {
        foreach (Excel.PivotTable pivotTable in sheet.PivotTables())
        {
            Excel.Range pivotRange = pivotTable.TableRange2;
            if (columnIndex >= pivotRange.Column && columnIndex < (pivotRange.Column + pivotRange.Columns.Count))
            {
                return true;
            }
        }
        return false;
    }

    private int GetColumnIndex(Excel.Worksheet sheet, string columnName)
    {
        Excel.Range headerRow = sheet.Rows[3]; // Assuming filters start from row 3
        Excel.Range column = headerRow.Find(columnName, Type.Missing, Excel.XlFindLookIn.xlValues, Excel.XlLookAt.xlWhole, Excel.XlSearchOrder.xlByColumns, Excel.XlSearchDirection.xlNext, false, Type.Missing, Type.Missing);

        if (column != null)
        {
            return column.Column;
        }
        else
        {
            Console.WriteLine("Column " + columnName + " not found.");
            return -1;
        }
    }

    private void ReleaseObject(object obj)
    {
        try
        {
            System.Runtime.InteropServices.Marshal.ReleaseComObject(obj);
            obj = null;
        }
        catch (Exception ex)
        {
            obj = null;
            Console.WriteLine("Exception occurred while releasing object: " + ex.ToString());
        }
        finally
        {
            GC.Collect();
        }
    }
}
