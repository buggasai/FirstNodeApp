using System;
using Excel = Microsoft.Office.Interop.Excel;

class Program
{
    static void Main()
    {
        Excel.Application excelApp = null;
        Excel.Workbook sourceWorkbook = null;
        Excel.Workbook destinationWorkbook = null;

        try
        {
            // Initialize the Excel application
            excelApp = new Excel.Application();
            excelApp.Visible = false; // Set to true for debugging, false for production

            // Define file paths
            string sourceFilePath = @"C:\path\to\your\source_excel_file.xlsx";
            string destinationFilePath = @"C:\path\to\your\destination_excel_file.xlsx";

            // Open the source workbook
            sourceWorkbook = excelApp.Workbooks.Open(sourceFilePath);
            Excel.Worksheet sourceWorksheet = sourceWorkbook.Sheets[1]; // Assuming the first worksheet

            // Get the used range of the source worksheet
            Excel.Range usedRange = sourceWorksheet.UsedRange;
            object[,] fullData = usedRange.Value2;

            // Determine dimensions
            int numRows = fullData.GetLength(0); // Including header row
            int numCols = fullData.GetLength(1);

            // Close the source workbook without saving changes
            sourceWorkbook.Close(false);

            // Open the destination workbook
            destinationWorkbook = excelApp.Workbooks.Open(destinationFilePath);
            Excel.Worksheet destinationWorksheet = destinationWorkbook.Sheets[1]; // Assuming the first worksheet

            // Define the starting cell for applying the formula (A9)
            int startRow = 9;
            int startCol = 1;

            // Get the range to apply the formula in destination worksheet
            Excel.Range formulaRange = destinationWorksheet.Cells[startRow, startCol];
            formulaRange.Resize[numRows, numCols].Formula = "=IF(AND(H9=0,I9=0),\"ja\",\"nein\")";

            // Save and close the destination workbook
            destinationWorkbook.Save();
            destinationWorkbook.Close();

            Console.WriteLine("Formula applied successfully.");
        }
        catch (Exception ex)
        {
            Console.WriteLine("An error occurred: " + ex.Message);
        }
        finally
        {
            // Quit the Excel application
            if (excelApp != null)
            {
                excelApp.Quit();
                System.Runtime.InteropServices.Marshal.ReleaseComObject(excelApp);
            }
        }
    }
}
