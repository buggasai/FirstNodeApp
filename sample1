using System;
using System.Runtime.InteropServices;
using Excel = Microsoft.Office.Interop.Excel;

class Program
{
    static void Main(string[] args)
    {
        string sourceFilePath = @"C:\path\to\source\file.xlsx";
        string sourceSheetName = "SourceSheet";
        string targetFilePath = @"C:\path\to\target\file.xlsx";
        string targetSheetName = "TargetSheet";

        Excel.Application excelApp = new Excel.Application();
        Excel.Workbook sourceWorkbook = null;
        Excel.Workbook targetWorkbook = null;
        Excel.Worksheet sourceWorksheet = null;
        Excel.Worksheet targetWorksheet = null;

        try
        {
            // Open the source workbook
            sourceWorkbook = excelApp.Workbooks.Open(sourceFilePath);
            sourceWorksheet = sourceWorkbook.Sheets[sourceSheetName] as Excel.Worksheet;

            // Open the target workbook
            targetWorkbook = excelApp.Workbooks.Open(targetFilePath);
            targetWorksheet = targetWorkbook.Sheets[targetSheetName] as Excel.Worksheet;

            if (sourceWorksheet != null && targetWorksheet != null)
            {
                // Insert two new columns before column A in the target worksheet
                Excel.Range columnA = targetWorksheet.Columns["A"];
                columnA.Insert(Excel.XlInsertShiftDirection.xlShiftToRight);
                columnA.Insert(Excel.XlInsertShiftDirection.xlShiftToRight);

                // Copy all used range from source worksheet
                Excel.Range sourceRange = sourceWorksheet.UsedRange;
                sourceRange.Copy();

                // Paste into the target worksheet starting at cell C1
                Excel.Range targetRange = targetWorksheet.Cells[1, 3] as Excel.Range;
                targetRange.PasteSpecial(Excel.XlPasteType.xlPasteAll);

                // Find the last used row in the target worksheet's column C (original column A)
                int lastRow = targetWorksheet.Cells[targetWorksheet.Rows.Count, "C"].End(Excel.XlDirection.xlUp).Row;

                // Populate the new column A with the formula ="" where column B has values
                Excel.Range newColumnA = targetWorksheet.Range["A1", $"A{lastRow}"];
                Excel.Range newColumnB = targetWorksheet.Range["B1", $"B{lastRow}"];
                
                // Setting formulas to entire columns A and B
                newColumnA.Formula = "=IF(C1<>\"\", \"\", \"\")"; // Adjust the formula as necessary
                newColumnB.Formula = "=IF(C1<>\"\", \"\", \"\")"; // Adjust the formula as necessary

                // Optional: Clear clipboard
                excelApp.CutCopyMode = Excel.XlCutCopyMode.xlCopy;

                // Save the target workbook
                targetWorkbook.Save();
                Console.WriteLine("Data copied successfully from source to target.");
            }
            else
            {
                Console.WriteLine("Source or target sheet not found.");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"An error occurred: {ex.Message}");
        }
        finally
        {
            // Clean up
            if (sourceWorkbook != null)
            {
                sourceWorkbook.Close(false);
                Marshal.ReleaseComObject(sourceWorkbook);
            }
            if (targetWorkbook != null)
            {
                targetWorkbook.Close(false);
                Marshal.ReleaseComObject(targetWorkbook);
            }
            excelApp.Quit();
            Marshal.ReleaseComObject(excelApp);
        }
    }
}
