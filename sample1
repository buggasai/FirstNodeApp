using System;
using System.Runtime.InteropServices;
using Excel = Microsoft.Office.Interop.Excel;

class Program
{
    static void Main()
    {
        // Create a new Excel application
        Excel.Application excelApp = new Excel.Application();

        // Make the application visible (optional for demonstration)
        excelApp.Visible = true;

        // Define the path to the workbook
        string filePath = @"C:\path\to\your\file.xlsx";

        // Open the workbook
        Excel.Workbook workbook = excelApp.Workbooks.Open(filePath);

        // Define the worksheet and pivot table name
        string worksheetName = "Sheet1"; // Replace with your worksheet name
        string pivotTableName = "PivotTable1"; // Replace with your pivot table name

        try
        {
            // Access the worksheet
            Excel.Worksheet worksheet = (Excel.Worksheet)workbook.Sheets[worksheetName];

            // Access the pivot table
            Excel.PivotTable pivotTable = worksheet.PivotTables(pivotTableName) as Excel.PivotTable;

            // Refresh the pivot table
            pivotTable.RefreshTable();

            // Access the pivot table's PivotField you want to sort
            Excel.PivotField pivotField = pivotTable.PivotFields("FieldName") as Excel.PivotField; // Replace "FieldName" with your field name

            // Apply sort on the pivot field
            pivotField.AutoSort(
                Order: Excel.XlSortOrder.xlAscending,
                Field: "FieldName"); // Sort the pivot field by name

            Console.WriteLine("Pivot table refreshed and sorted successfully.");
        }
        catch (COMException comEx)
        {
            Console.WriteLine($"COM Error: {comEx.Message}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"General Error: {ex.Message}");
        }
        finally
        {
            // Close the workbook and quit Excel application
            workbook.Close(false);
            excelApp.Quit();

            // Clean up
            Marshal.ReleaseComObject(workbook);
            Marshal.ReleaseComObject(excelApp);

            GC.Collect();
            GC.WaitForPendingFinalizers();
        }
    }
}
