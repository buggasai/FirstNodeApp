using System;
using Excel = Microsoft.Office.Interop.Excel;

class Program
{
    static void Main()
    {
        Excel.Application excelApp = null;
        Excel.Workbook sourceWorkbook = null;
        Excel.Workbook destinationWorkbook = null;

        try
        {
            // Start Excel application
            excelApp = new Excel.Application();
            
            // Make Excel visible (optional)
            excelApp.Visible = false;

            // Paths to the source and destination Excel files
            string sourceFilePath = "source_excel_file.xlsx";
            string destinationFilePath = "destination_excel_file.xlsx";

            // Open the source Excel file
            sourceWorkbook = excelApp.Workbooks.Open(sourceFilePath);
            Excel.Worksheet sourceWorksheet = sourceWorkbook.Sheets[1]; // Assumes the first worksheet

            // Open the destination Excel file
            destinationWorkbook = excelApp.Workbooks.Open(destinationFilePath);
            Excel.Worksheet destinationWorksheet = destinationWorkbook.Sheets[1]; // Assumes the first worksheet

            // Clear the contents and formatting of the destination sheet
            Excel.Range destinationUsedRange = destinationWorksheet.UsedRange;
            destinationUsedRange.Clear(); // Clears both content and formatting

            // Get the used range of the source worksheet
            Excel.Range sourceUsedRange = sourceWorksheet.UsedRange;

            // Get the total number of rows and columns in the used range
            int totalRows = sourceUsedRange.Rows.Count;
            int totalColumns = sourceUsedRange.Columns.Count;

            // Copy data from the source to the destination cell by cell
            for (int row = 1; row <= totalRows; row++)
            {
                for (int col = 1; col <= totalColumns; col++)
                {
                    Excel.Range sourceCell = sourceWorksheet.Cells[row, col];
                    Excel.Range destinationCell = destinationWorksheet.Cells[row, col];
                    destinationCell.Value = sourceCell.Value;
                }
            }

            // Copy formats from the source to the destination cell by cell
            for (int row = 1; row <= totalRows; row++)
            {
                for (int col = 1; col <= totalColumns; col++)
                {
                    Excel.Range sourceCell = sourceWorksheet.Cells[row, col];
                    Excel.Range destinationCell = destinationWorksheet.Cells[row, col];
                    sourceCell.Copy(destinationCell);
                    destinationCell.PasteSpecial(Excel.XlPasteType.xlPasteFormats);
                }
            }

            // Save the destination workbook
            destinationWorkbook.Save();
        }
        catch (Exception ex)
        {
            Console.WriteLine("An error occurred: " + ex.Message);
        }
        finally
        {
            // Close the workbooks and quit Excel
            if (sourceWorkbook != null)
            {
                sourceWorkbook.Close(false);
                System.Runtime.InteropServices.Marshal.ReleaseComObject(sourceWorkbook);
            }

            if (destinationWorkbook != null)
            {
                destinationWorkbook.Close(false);
                System.Runtime.InteropServices.Marshal.ReleaseComObject(destinationWorkbook);
            }

            if (excelApp != null)
            {
                excelApp.Quit();
                System.Runtime.InteropServices.Marshal.ReleaseComObject(excelApp);
            }

            Console.WriteLine("Operation completed.");
        }
    }
}
