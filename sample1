using System;
using System.Runtime.InteropServices;
using Excel = Microsoft.Office.Interop.Excel;

class Program
{
    static void Main()
    {
        // Create a new Excel application
        Excel.Application excelApp = new Excel.Application();
        excelApp.Visible = true; // Make Excel application visible for debugging

        Excel.Workbook workbook = null;

        try
        {
            // Define the path to the workbook
            string filePath = @"C:\path\to\your\file.xlsx";

            // Open the workbook
            workbook = excelApp.Workbooks.Open(filePath);

            // Define the worksheet name
            string worksheetName = "Sheet1"; // Replace with your worksheet name

            // Access the worksheet
            Excel.Worksheet worksheet = (Excel.Worksheet)workbook.Sheets[worksheetName];

            // Get the used range of the worksheet
            Excel.Range usedRange = worksheet.UsedRange;

            // Get the column E range starting from the second row to the last used row
            int rowCount = usedRange.Rows.Count;
            Excel.Range columnERange = worksheet.Range["E2:E" + rowCount];

            // Ensure the cell format is set to General before applying formulas
            columnERange.NumberFormat = "General"; // Set to General format

            // Construct dynamic formula for the entire column E
            string[] formulas = new string[rowCount - 1]; // Array to hold all formulas
            for (int row = 2; row <= rowCount; row++)
            {
                formulas[row - 2] = $"=IF(A{row}<>\"ja\",0,IF(B{row}<$K$2, ...))"; // Example dynamic formula
            }

            // Apply formulas to the entire column E using Formula
            for (int row = 2; row <= rowCount; row++)
            {
                worksheet.Cells[row, 5].Formula = formulas[row - 2]; // Column E is the 5th column
            }

            // Force Excel to recalculate
            workbook.Application.Calculate();

            Console.WriteLine("Dynamic formulas applied to column E successfully.");

            // Save the workbook if needed
            // workbook.Save();
        }
        catch (COMException comEx)
        {
            Console.WriteLine($"COM Error: {comEx.Message}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"General Error: {ex.Message}");
        }
        finally
        {
            // Close the workbook and quit Excel application
            if (workbook != null)
            {
                workbook.Close(false);
                Marshal.ReleaseComObject(workbook);
            }
            excelApp.Quit();
            Marshal.ReleaseComObject(excelApp);

            GC.Collect();
            GC.WaitForPendingFinalizers();
        }
    }
}
