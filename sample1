using Excel = Microsoft.Office.Interop.Excel;

public void SortExcelWithFilters(string filePath)
{
    // Create a new Excel application
    Excel.Application excelApp = new Excel.Application();
    
    // Open the workbook
    Excel.Workbook workbook = excelApp.Workbooks.Open(filePath);
    Excel.Worksheet worksheet = workbook.Sheets[1];

    // Turn on AutoFilter if it's not already enabled (header in the 8th row)
    Excel.Range headerRange = worksheet.Range["A8:H8"];  // Adjust range to include the necessary columns
    if (!worksheet.AutoFilterMode)
    {
        headerRange.AutoFilter();
    }

    // Sort by Column E (Oldest to Newest)
    worksheet.AutoFilter.Sort.SortFields.Clear();
    worksheet.AutoFilter.Sort.SortFields.Add(
        Key: worksheet.Columns["E"],
        SortOn: Excel.XlSortOn.xlSortOnValues,
        Order: Excel.XlSortOrder.xlAscending // Oldest to Newest
    );
    
    // Apply the sort for Column E
    worksheet.AutoFilter.ApplyFilter();

    // Sort by Column H (Smallest to Largest)
    worksheet.AutoFilter.Sort.SortFields.Clear();
    worksheet.AutoFilter.Sort.SortFields.Add(
        Key: worksheet.Columns["H"],
        SortOn: Excel.XlSortOn.xlSortOnValues,
        Order: Excel.XlSortOrder.xlAscending
    );
    
    // Apply the sort for Column H
    worksheet.AutoFilter.ApplyFilter();

    // Sort by Column B (Smallest to Largest)
    worksheet.AutoFilter.Sort.SortFields.Clear();
    worksheet.AutoFilter.Sort.SortFields.Add(
        Key: worksheet.Columns["B"],
        SortOn: Excel.XlSortOn.xlSortOnValues,
        Order: Excel.XlSortOrder.xlAscending
    );

    // Apply the sort for Column B
    worksheet.AutoFilter.ApplyFilter();

    // Save and close the workbook
    workbook.Save();
    workbook.Close();
    excelApp.Quit();

    // Release COM objects to avoid memory leaks
    System.Runtime.InteropServices.Marshal.ReleaseComObject(worksheet);
    System.Runtime.InteropServices.Marshal.ReleaseComObject(workbook);
    System.Runtime.InteropServices.Marshal.ReleaseComObject(excelApp);
}
