using System;
using System.Data;
using System.Linq;

class Program
{
    static void Main()
    {
        // Sample source DataTable
        DataTable sourceDataTable = new DataTable();
        sourceDataTable.Columns.Add("ID", typeof(int));
        sourceDataTable.Columns.Add("Name", typeof(string));
        sourceDataTable.Rows.Add(1, "John");
        sourceDataTable.Rows.Add(2, "Jane");
        sourceDataTable.Rows.Add(3, "Doe");

        // Sample target DataTable with differences
        DataTable targetDataTable = new DataTable();
        targetDataTable.Columns.Add("ID", typeof(int));
        targetDataTable.Columns.Add("Name", typeof(string));
        targetDataTable.Rows.Add(1, "John");
        targetDataTable.Rows.Add(2, "JaneUpdated"); // Difference
        targetDataTable.Rows.Add(4, "NewPerson");   // Difference

        // Create a list to store columns to be added
        var columnsToAdd = sourceDataTable.Columns.Cast<DataColumn>().Select(col => col.ColumnName).ToList();

        // Add additional columns to the source DataTable for differences
        foreach (var column in columnsToAdd)
        {
            sourceDataTable.Columns.Add($"{column}_Diff", typeof(string));
        }

        // Retrieve column names dynamically excluding columns not in the table
        string[] columnsToCompare = sourceDataTable.Columns.Cast<DataColumn>()
            .Where(col => targetDataTable.Columns.Contains(col.ColumnName))
            .Select(col => col.ColumnName)
            .ToArray();

        // Use LINQ to compare and concatenate differences
        var differences = from row in sourceDataTable.AsEnumerable().Concat(targetDataTable.AsEnumerable())
                          group row by columnsToCompare.Select(col => row.Field<object>(col)).ToArray() into grouped
                          where grouped.Count() == 1
                          from row in grouped
                          select row;

        // Update the differences columns in the source DataTable
        foreach (var diffRow in differences)
        {
            DataRow sourceRow = sourceDataTable.Rows.Contains(diffRow.ItemArray) ? sourceDataTable.Rows.Find(diffRow.ItemArray) : null;
            DataRow targetRow = targetDataTable.Rows.Contains(diffRow.ItemArray) ? targetDataTable.Rows.Find(diffRow.ItemArray) : null;

            foreach (var col in columnsToCompare)
            {
                string diffColumnName = $"{col}_Diff";
                string diffValue = (sourceRow != null && targetRow != null && !sourceRow[col].Equals(targetRow[col]))
                    ? $"{sourceRow[col]} -> {targetRow[col]}"
                    : string.Empty;

                sourceRow?.SetField(diffColumnName, diffValue);
            }
        }

        // Display the result
        foreach (DataRow row in sourceDataTable.Rows)
        {
            Console.WriteLine($"Values: {string.Join(", ", columnsToCompare.Select(col => $"{col}: {row[col]}"))}");

            foreach (var col in columnsToCompare)
            {
                string diffColumnName = $"{col}_Diff";
                Console.WriteLine($"{diffColumnName}: {row[diffColumnName]}");
            }

            Console.WriteLine();
        }
    }
}
